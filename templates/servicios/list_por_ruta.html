{% extends "base.html" %}
{% load l10n formatting %}
{% block title %}Servicios de la ruta #{{ ruta.id }}{% endblock %}

{% block extra_css %}
<style>
  /* ===== Acciones compactas en la tabla de servicios ===== */
  table.table td.actions{
    text-align:right;
    white-space:nowrap;
    vertical-align:middle;
  }
  table.table td.actions .row-actions{
    display:flex !important;
    gap:8px !important;
    flex-wrap:wrap !important;
    justify-content:flex-end !important;
    align-items:center !important;
  }
  table.table td.actions form{
    display:inline-block !important;
    margin:0 !important;
  }
  .btn-compact{
    display:inline-flex !important;
    align-items:center !important;
    justify-content:center !important;
    padding:6px 12px !important;
    font-size:.92rem !important;
    line-height:1.15 !important;
    border-radius:12px !important;
    height:auto !important;
    min-height:unset !important;
    min-width:unset !important;
  }
  @media (max-width: 900px){
    table.table td.actions{ text-align:left; }
    table.table td.actions .row-actions{ justify-content:flex-start !important; }
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="m-0">Servicios ‚Äî Ruta #{{ ruta.id }} {{ ruta.nombre|default:"" }}</h1>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'rutas:list' %}">‚¨ÖÔ∏è Rutas</a>
    <a class="btn btn-outline-dark" href="{% url 'rutas:hoja' ruta.id %}">üßæ Hoja de ruta</a>
    {% if es_gerente and ruta.estado == 'ACTIVA' %}
      <a class="btn btn-primary" href="{% url 'servicios:crear' %}?ruta={{ ruta.id }}">‚ûï Agregar servicio</a>
    {% endif %}
  </div>
</div>

<p class="text-muted">
  <strong>Fecha:</strong> {{ ruta.fecha_salida|date:"Y-m-d" }} ‚Äî
  <strong>Veh√≠culo:</strong> {{ ruta.vehiculo|default:"‚Äî" }} ‚Äî
  <strong>Conductor:</strong> {{ ruta.conductor.username|default:"‚Äî" }} ‚Äî
  <strong>Estado:</strong>
  {% if ruta.estado == 'ACTIVA' %}<span class="badge text-bg-success">ACTIVA</span>
  {% else %}<span class="badge text-bg-secondary">CERRADA</span>{% endif %}
</p>

<div class="card">
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Cliente</th>
          <th>Origen ‚Üí Destino</th>
          <th class="text-end">Valor</th>
          <th>Pago</th>
          <th>Estado</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for s in servicios %}
          <tr>
            <td>{{ s.id }}</td>
            <td>{{ s.cliente }}</td>
            <td>
              <small>{{ s.origen|default:"‚Äî" }} ‚Üí {{ s.destino|default:"‚Äî" }}</small>
              <div class="small">
                {% if s.lat_recogida and s.lon_recogida %}
                  <a class="link-secondary" target="_blank"
                     href="https://www.google.com/maps/dir/?api=1&destination={{ s.lat_recogida|unlocalize }},{{ s.lon_recogida|unlocalize }}">üìç Ir a recogida</a>
                  ¬∑ <a class="link-secondary" target="_blank"
                       href="https://www.google.com/maps/search/?api=1&query={{ s.lat_recogida|unlocalize }},{{ s.lon_recogida|unlocalize }}">üîé Ver</a>
                {% endif %}
                {% if s.lat_entrega and s.lon_entrega %}
                  ¬∑ <a class="link-secondary" target="_blank"
                       href="https://www.google.com/maps/dir/?api=1&destination={{ s.lat_entrega|unlocalize }},{{ s.lon_entrega|unlocalize }}">üì¶ Ir a entrega</a>
                  <a class="link-secondary" target="_blank"
                       href="https://www.google.com/maps/search/?api=1&query={{ s.lat_entrega|unlocalize }},{{ s.lon_entrega|unlocalize }}">üîé Ver</a>
                {% endif %}
              </div>
            </td>
            <td class="text-end">{{ s.valor|money }}</td>
            <td>
              {% if s.estado_pago == 'PAG' %}
                <span class="badge text-bg-success">Pagado</span>
              {% elif s.estado_pago == 'ANT' %}
                <span class="badge text-bg-warning">Anticipo {{ s.anticipo|money }}</span>
              {% else %}
                <span class="badge text-bg-secondary">Pendiente</span>
              {% endif %}
            </td>
            <td>
              {% if s.entregado %}‚úÖ Entregado
              {% elif s.recogido %}üì¶ En ruta
              {% else %}‚è≥ Pendiente
              {% endif %}
              <div class="small text-muted">
                {% if s.recogido_en %}Recogido: {{ s.recogido_en|date:"Y-m-d H:i" }}{% endif %}
                {% if s.entregado_en %} ¬∑ Entregado: {{ s.entregado_en|date:"Y-m-d H:i" }}{% endif %}
              </div>
            </td>

            <!-- ACCIONES -->
            <td class="actions">
              <div class="row-actions">
                <a class="btn btn-outline-primary btn-compact" href="{% url 'servicios:detail' s.id %}">Detalle</a>

                {% if ruta.estado == 'ACTIVA' %}
                  {% if es_gerente or es_conductor %}
                    {% if not s.recogido %}
                      <form id="rec-{{ s.id }}" method="post" action="{% url 'servicios:marcar_recogido' s.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="lat" id="rec-lat-{{ s.id }}">
                        <input type="hidden" name="lon" id="rec-lon-{{ s.id }}">
                        <button type="button"
                                class="btn btn-outline-info btn-compact"
                                onclick="enviarConUbicacion('rec-{{ s.id }}','rec-lat-{{ s.id }}','rec-lon-{{ s.id }}')">
                          Marcar recogido
                        </button>
                      </form>
                    {% endif %}
                    {% if s.recogido and not s.entregado %}
                      <form id="ent-{{ s.id }}" method="post" action="{% url 'servicios:marcar_entregado' s.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="lat" id="ent-lat-{{ s.id }}">
                        <input type="hidden" name="lon" id="ent-lon-{{ s.id }}">
                        <button type="button"
                                class="btn btn-outline-success btn-compact"
                                onclick="enviarConUbicacion('ent-{{ s.id }}','ent-lat-{{ s.id }}','ent-lon-{{ s.id }}')">
                          Marcar entregado
                        </button>
                      </form>
                    {% endif %}
                  {% endif %}
                {% endif %}
              </div>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="7" class="text-center text-muted py-4">Sin servicios en esta ruta.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* Igual que en detalle: obtiene coords y env√≠a el form */
function enviarConUbicacion(formId, latId, lonId){
  const form = document.getElementById(formId);
  if (!form) return;
  if (!navigator.geolocation){ form.submit(); return; }

  navigator.geolocation.getCurrentPosition(
    function(pos){
      const lat = document.getElementById(latId);
      const lon = document.getElementById(lonId);
      if(lat) lat.value = pos.coords.latitude;
      if(lon) lon.value = pos.coords.longitude;
      form.submit();
    },
    function(){ form.submit(); },
    { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
  );
}
</script>
{% endblock %}
