{% extends "base.html" %}
{% load l10n formatting %}
{% block title %}Servicios de la ruta #{{ ruta.id }}{% endblock %}

{% block extra_css %}
<style>
/* ===== Scope: solo dentro de #svc-list ===== */
#svc-list .only-desktop{display:block !important;}
#svc-list .only-mobile{display:none !important;}
@media (max-width: 767.98px){
  #svc-list .only-desktop{display:none !important;}
  #svc-list .only-mobile{display:block !important;}
}

/* tabla (desktop) */
table.table td.actions{text-align:right;white-space:nowrap;vertical-align:middle;}
table.table td.actions .row-actions{display:flex !important;gap:8px !important;flex-wrap:wrap !important;justify-content:flex-end !important;align-items:center !important;}
table.table td.actions form{display:inline-block !important;margin:0 !important;}
.btn-compact{display:inline-flex !important;align-items:center !important;justify-content:center !important;padding:6px 12px !important;font-size:.92rem !important;line-height:1.15 !important;border-radius:12px !important;}
@media (max-width: 900px){
  table.table td.actions{text-align:left;}
  table.table td.actions .row-actions{justify-content:flex-start !important;}
}

/* cards (m√≥vil) */
.cards-grid{display:grid;gap:12px;}
.card-svc{border:1px solid #eceef3;background:#fff;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.05);}
.card-svc .body{padding:14px 16px;}
.card-svc .footer{padding:12px 16px;display:flex;gap:8px;justify-content:flex-end;}
.svc-head{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;}
.svc-title{margin:0;font-size:16px;}
.svc-sub{margin-top:2px;color:#6b7280;font-size:12.5px;}
.svc-meta{display:grid;gap:6px;margin:10px 0 0;}
.svc-meta dt{font-weight:700;color:#2b2f3a;}
.svc-meta dd{margin:0;color:#333;}
.svc-links{margin-top:6px;font-size:12.5px;}
.svc-links a{color:#6b7280;text-decoration:none;}
.svc-links a:hover{text-decoration:underline;}

@media (max-width: 767.98px){
  .cards-grid{grid-template-columns:1fr;}
  @supports (aspect-ratio:1){
    .card-svc{aspect-ratio:1.05/1;display:flex;flex-direction:column;}
    .card-svc .body{flex:1 1 auto;overflow:auto;}
  }
}

/* ====== Drag & drop ====== (m√≠nimo y aislado) */
/* ====== Drag & drop ====== */
.drag-handle {
  cursor: grab;
  user-select: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
  background: #f9fafb;
  transition: background 0.15s ease, border-color 0.15s ease;
}
.drag-handle:hover {
  background: #f3f4f6;
  border-color: #d1d5db;
}
.drag-handle:active {
  cursor: grabbing;
  background: #e0f2fe;
  border-color: #60a5fa;
}
.drag-handle .dots {
  width: 12px;
  height: 12px;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  grid-template-rows: repeat(3, 1fr);
  gap: 2px;
}
.drag-handle .dots::before,
.drag-handle .dots::after,
.drag-handle .dots div {
  content: "";
  width: 3px;
  height: 3px;
  background-color: #6b7280;
  border-radius: 50%;
  display: block;
}
.sortable-chosen { opacity: 0.7; }
.sortable-ghost { opacity: 0.4; background: #f6f7fb; }

</style>
{% endblock %}

{% block content %}
<div id="svc-list">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="m-0">Servicios ‚Äî Ruta #{{ ruta.id }} {{ ruta.nombre|default:"" }}</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'rutas:list' %}">‚¨ÖÔ∏è Rutas</a>
      {% if ruta and ruta.pk %}
        <a class="btn btn-outline-dark" href="{% url 'rutas:hoja' ruta.pk %}">üßæ Hoja de ruta</a>
      {% endif %}
      {% if es_gerente and ruta.estado == 'ACTIVA' %}
        <a class="btn btn-primary" href="{% url 'servicios:crear' %}?ruta={{ ruta.pk }}">‚ûï Agregar servicio</a>
      {% endif %}
    </div>

  </div>

  <p class="text-muted">
    <strong>Fecha:</strong> {{ ruta.fecha_salida|date:"Y-m-d" }} ‚Äî
    <strong>Veh√≠culo:</strong> {{ ruta.vehiculo|default:"‚Äî" }} ‚Äî
    <strong>Conductor:</strong> {{ ruta.conductor.username|default:"‚Äî" }} ‚Äî
    <strong>Estado:</strong>
    {% if ruta.estado == 'ACTIVA' %}<span class="badge text-bg-success">ACTIVA</span>
    {% else %}<span class="badge text-bg-secondary">CERRADA</span>{% endif %}
  </p>

  {# ===== Desktop/Tablet: TABLA ===== #}
  <div class="card only-desktop">
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            {% if es_gerente and ruta.estado == 'ACTIVA' %}
              <th class="text-center" style="width:46px;"></th>
            {% endif %}
            <th>Orden</th>
            <th>#</th>
            <th>Cliente</th>
            <th>Origen ‚Üí Destino</th>
            <th class="text-end">Valor</th>
            <th>Pago</th>
            <th>Estado</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla-servicios">
          {% for s in servicios %}
          <tr data-id="{{ s.id }}">
            {% if es_gerente and ruta.estado == 'ACTIVA' %}
              <td class="text-center">
                <button type="button" class="drag-handle" aria-label="Reordenar">
                  <span class="dots"><div></div><div></div><div></div><div></div></span>
                </button>

              </td>
            {% endif %}
            <td>{{ s.orden }}</td>
            <td>{{ s.id }}</td>
            <td>{{ s.cliente }}</td>
            <td>
              <small>{{ s.origen|default:"‚Äî" }} ‚Üí {{ s.destino|default:"‚Äî" }}</small>
              
            </td>
            <td class="text-end">{{ s.valor|money }}</td>
            <td>
              {% if s.estado_pago == 'PAG' %}
                <span class="badge text-bg-success">Pagado</span>
              {% elif s.estado_pago == 'ANT' %}
                <span class="badge text-bg-warning">Anticipo {{ s.anticipo|money }}</span>
              {% else %}
                <span class="badge text-bg-secondary">Pendiente</span>
              {% endif %}
            </td>
            <td>
              {% if s.entregado %}‚úÖ Entregado
              {% elif s.recogido %}üì¶ En ruta
              {% else %}‚è≥ Pendiente
              {% endif %}
              <div class="small text-muted">
                {% if s.recogido_en %}Recogido: {{ s.recogido_en|date:"Y-m-d H:i" }}{% endif %}
                {% if s.entregado_en %} ¬∑ Entregado: {{ s.entregado_en|date:"Y-m-d H:i" }}{% endif %}
              </div>
            </td>

            <td class="actions">
              <div class="row-actions">
                <a class="btn btn-outline-primary btn-compact" href="{% url 'servicios:detail' s.id %}">Detalle</a>

                {# FIX: sin par√©ntesis; if anidados #}
                {% if ruta.estado == 'ACTIVA' %}
                  {% if es_gerente or es_conductor %}
                    {% if not s.recogido %}
                      <form id="rec-{{ s.id }}" method="post" action="{% url 'servicios:marcar_recogido' s.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="lat" id="rec-lat-{{ s.id }}">
                        <input type="hidden" name="lon" id="rec-lon-{{ s.id }}">
                        <button type="button" class="btn btn-outline-info btn-compact"
                                onclick="enviarConUbicacion('rec-{{ s.id }}','rec-lat-{{ s.id }}','rec-lon-{{ s.id }}')">
                          Marcar recogido
                        </button>
                      </form>
                    {% endif %}
                    {% if s.recogido and not s.entregado %}
                      <form id="ent-{{ s.id }}" method="post" action="{% url 'servicios:marcar_entregado' s.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="lat" id="ent-lat-{{ s.id }}">
                        <input type="hidden" name="lon" id="ent-lon-{{ s.id }}">
                        <button type="button" class="btn btn-outline-success btn-compact"
                                onclick="enviarConUbicacion('ent-{{ s.id }}','ent-lat-{{ s.id }}','ent-lon-{{ s.id }}')">
                          Marcar entregado
                        </button>
                      </form>
                    {% endif %}
                  {% endif %}
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
            <tr><td colspan="{% if es_gerente and ruta.estado == 'ACTIVA' %}8{% else %}7{% endif %}" class="text-center text-muted py-4">Sin servicios en esta ruta.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {# ===== M√≥vil: CARDS ===== #}
  <div class="only-mobile cards-grid" id="cards-servicios">
    {% for s in servicios %}
    <article class="card-svc" data-id="{{ s.id }}">
      <div class="body">
        <div class="svc-head">
          <h5 class="svc-title">Servicio #{{ s.id }}</h5>
          <span class="badge
            {% if s.estado_pago == 'PAG' %}text-bg-success
            {% elif s.estado_pago == 'ANT' %}text-bg-warning
            {% else %}text-bg-secondary{% endif %}">
            {% if s.estado_pago == 'PAG' %}Pagado{% elif s.estado_pago == 'ANT' %}Anticipo{% else %}Pendiente{% endif %}
          </span>
        </div>
        <div class="svc-sub">Ruta #{{ ruta.id }} ‚Äî {{ s.origen|default:"‚Äî" }} ‚Üí {{ s.destino|default:"‚Äî" }}</div>
        <dl class="svc-meta">
          <div><dt>Cliente</dt><dd>{{ s.cliente }}</dd></div>
          <div><dt>Valor</dt><dd>{{ s.valor|money }}</dd></div>
          <div><dt>Estado</dt><dd>
            {% if s.entregado %}‚úÖ Entregado
            {% elif s.recogido %}üì¶ En ruta
            {% else %}‚è≥ Pendiente{% endif %}
          </dd></div>
        </dl>
        <div class="svc-links">
          {% if s.lat_recogida and s.lon_recogida %}
            <a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination={{ s.lat_recogida|unlocalize }},{{ s.lon_recogida|unlocalize }}">üìç Ir a recogida</a>
            ¬∑ <a target="_blank" href="https://www.google.com/maps/search/?api=1&query={{ s.lat_recogida|unlocalize }},{{ s.lon_recogida|unlocalize }}">üîé Ver</a>
          {% endif %}
          {% if s.lat_entrega and s.lon_entrega %}
            ¬∑ <a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination={{ s.lat_entrega|unlocalize }},{{ s.lon_entrega|unlocalize }}">üì¶ Ir a entrega</a>
            ¬∑ <a target="_blank" href="https://www.google.com/maps/search/?api=1&query={{ s.lat_entrega|unlocalize }},{{ s.lon_entrega|unlocalize }}">üîé Ver</a>
          {% endif %}
        </div>
      </div>
      <div class="footer">
        <a class="btn btn-sm btn-outline-primary" href="{% url 'servicios:detail' s.id %}">Detalle</a>

        {# FIX: sin par√©ntesis; if anidados #}
        {% if ruta.estado == 'ACTIVA' %}
          {% if es_gerente or es_conductor %}
            {% if not s.recogido %}
              <form id="mrec-{{ s.id }}" method="post" action="{% url 'servicios:marcar_recogido' s.id %}">
                {% csrf_token %}
                <input type="hidden" name="lat" id="mrec-lat-{{ s.id }}">
                <input type="hidden" name="lon" id="mrec-lon-{{ s.id }}">
                <button type="button" class="btn btn-sm btn-outline-info"
                        onclick="enviarConUbicacion('mrec-{{ s.id }}','mrec-lat-{{ s.id }}','mrec-lon-{{ s.id }}')">
                  Recogido
                </button>
              </form>
            {% endif %}
            {% if s.recogido and not s.entregado %}
              <form id="ment-{{ s.id }}" method="post" action="{% url 'servicios:marcar_entregado' s.id %}">
                {% csrf_token %}
                <input type="hidden" name="lat" id="ment-lat-{{ s.id }}">
                <input type="hidden" name="lon" id="ment-lon-{{ s.id }}">
                <button type="button" class="btn btn-sm btn-outline-success"
                        onclick="enviarConUbicacion('ment-{{ s.id }}','ment-lat-{{ s.id }}','ment-lon-{{ s.id }}')">
                  Entregado
                </button>
              </form>
            {% endif %}
          {% endif %}
        {% endif %}
      </div>
    </article>
    {% empty %}
      <div class="text-muted">Sin servicios en esta ruta.</div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function enviarConUbicacion(formId, latId, lonId){
  const form = document.getElementById(formId);
  if (!form) return;
  if (!navigator.geolocation){ form.submit(); return; }
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      const lat = document.getElementById(latId);
      const lon = document.getElementById(lonId);
      if(lat) lat.value = pos.coords.latitude;
      if(lon) lon.value = pos.coords.longitude;
      form.submit();
    },
    ()=>{ form.submit(); },
    { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
  );
}
</script>

{% if es_gerente and ruta.estado == 'ACTIVA' %}
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script>
  (function(){
    function getCookie(name){
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i=0;i<cookies.length;i++){
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length+1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length+1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    async function sendOrder(order){
      const resp = await fetch("{% url 'rutas:reordenar_servicios' ruta.id %}", {
        method: "POST",
        headers: {"Content-Type":"application/json","X-CSRFToken": csrftoken},
        body: JSON.stringify(order),
        credentials: "same-origin"
      });
      if (resp.ok){
        // feedback visible
        const n = document.createElement('div');
        n.textContent = "Orden guardado";
        n.style.cssText = "position:fixed;bottom:14px;left:14px;background:#0d6efd;color:#fff;padding:8px 12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.15);z-index:9999;";
        document.body.appendChild(n);
        setTimeout(()=>n.remove(), 1200);
      } else {
        const t = await resp.text();
        console.error("Guardar orden:", resp.status, t);
        alert("No se pudo guardar el nuevo orden.");
      }
    }

    function ids(container, selector){
      return Array.from(container.querySelectorAll(selector))
                  .map(el => parseInt(el.dataset.id));
    }

    const tbody = document.getElementById('tabla-servicios');
    if (tbody){
      Sortable.create(tbody, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        delayOnTouchOnly: true,
        delay: 150,
        onEnd(){ sendOrder(ids(tbody, 'tr[data-id]')); }
      });
    }

    const cards = document.getElementById('cards-servicios');
    if (cards){
      Sortable.create(cards, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        delayOnTouchOnly: true,
        delay: 150,
        onEnd(){ sendOrder(ids(cards, '.card-svc[data-id]')); }
      });
    }
  })();
  </script>
{% endif %}

{% endblock %}
