{% extends "base.html" %}
{% load l10n formatting %}
{% block title %}Servicios de la ruta #{{ ruta.id }}{% endblock %}

{% block extra_css %}
<style>
/* ===== Visibilidad por dispositivo ===== */
#svc-list .only-desktop{display:block !important;}
#svc-list .only-mobile{display:none !important;}
@media (max-width: 767.98px){
  #svc-list .only-desktop{display:none !important;}
  #svc-list .only-mobile{display:block !important;}
}

/* ===== Botonera superior ===== */
.top-actions{
  display:flex; gap:12px; flex-wrap:wrap;
  margin: 8px 0 12px;
}
.top-actions .btn{ display:inline-flex; align-items:center; gap:8px; }

/* ===== Handle drag (6 punticos) ===== */
.drag-handle{
  cursor:grab; user-select:none; display:inline-flex; align-items:center; justify-content:center;
  width:28px; height:28px; border-radius:6px; border:1px solid #e5e7eb; background:#f9fafb;
}
.drag-handle .dots{display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(3,1fr);gap:2px;}
.drag-handle .dots div{width:3px;height:3px;background:#6b7280;border-radius:50%;}
.sortable-chosen{opacity:.7;} .sortable-ghost{opacity:.4;background:#f6f7fb;}

/* ===== Cards m√≥viles compactas ===== */
.cards-grid{display:grid;gap:10px;}
.card-svc{border:1px solid #eceef3;background:#fff;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.05);}
.card-svc--compact .body{
  padding:10px 12px;
  display:grid;
  grid-template-columns:auto 36px 1fr auto;
  grid-template-rows:auto auto auto;
  align-items:center;
  column-gap:10px;row-gap:4px;
}
.order-badge{
  font-size:12px;font-weight:600;color:#374151;background:#f3f4f6;border:1px solid #e5e7eb;
  padding:4px 8px;border-radius:8px;text-align:center;
}
.title{font-size:14px;font-weight:700;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sub{grid-column:3 / span 2;color:#6b7280;font-size:12px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* Botoncitos inline */
.inline-actions{
  grid-column:3 / span 2;
  display:flex; gap:8px; justify-content:flex-start; align-items:center;
}
.btn-chip{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 10px;font-size:12.5px;line-height:1.2;border-radius:999px;
  border:1px solid #d1d5db;background:#f9fafb;color:#111827;
}
.btn-chip:hover{background:#f3f4f6;}
.btn-chip-success{border-color:#16a34a;color:#065f46;background:#ecfdf5;}
.btn-chip-info{border-color:#2563eb;color:#1e3a8a;background:#eff6ff;}

/* Estado (reemplaza la burbuja de #id) */
.status-pill{
  font-size:12px;font-weight:600;padding:4px 10px;border-radius:999px;text-align:center;white-space:nowrap;
}
.status-pendiente{background:#f3f4f6;color:#374151;border:1px solid #d1d5db;}
.status-enruta{background:#eff6ff;color:#1e3a8a;border:1px solid #93c5fd;}
.status-entregado{background:#ecfdf5;color:#065f46;border:1px solid #16a34a;}

/* Card clickable (sin overlay para no bloquear botones) */
.card-link{position:relative;}
.card-link:active{transform:scale(.995);}

/* === Botonera en la columna "Acciones" (desktop) === */
table.table td.actions .row-actions{
  display:flex !important;
  flex-direction: column;        /* apilar */
  align-items: flex-end;         /* alineado a la derecha */
  gap: 8px !important;           /* üëà aire entre botones */
}

/* Tama√±o y est√©tica uniforme para ambos botones */
table.table td.actions .row-actions .btn{
  padding: 6px 12px !important;  /* misma altura */
  font-size: .92rem !important;
  line-height: 1.15 !important;
  border-radius: 12px !important;
  min-width: 150px;              /* üëà mismo ancho visual */
}


</style>
{% endblock %}

{% block content %}
<div id="svc-list">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h1 class="m-0">Servicios ‚Äî Ruta #{{ ruta.id }} {{ ruta.nombre|default:"" }}</h1>
  </div>

  <div class="top-actions">
    <a class="btn btn-outline-secondary" href="{% url 'rutas:list' %}">‚¨ÖÔ∏è Rutas</a>
    {% if ruta and ruta.pk %}
      <a class="btn btn-outline-dark" href="{% url 'rutas:hoja' ruta.pk %}">üßæ Hoja de ruta</a>
    {% endif %}
    {% if es_gerente and ruta.estado == 'ACTIVA' %}
      <a class="btn btn-primary" href="{% url 'servicios:crear' %}?ruta={{ ruta.pk }}">‚ûï Agregar servicio</a>
    {% endif %}
  </div>

  <p class="text-muted">
    <strong>Fecha:</strong> {{ ruta.fecha_salida|date:"Y-m-d" }} ‚Äî
    <strong>Veh√≠culo:</strong> {{ ruta.vehiculo|default:"‚Äî" }} ‚Äî
    <strong>Conductor:</strong> {{ ruta.conductor.username|default:"‚Äî" }} ‚Äî
    <strong>Estado:</strong>
    {% if ruta.estado == 'ACTIVA' %}<span class="badge text-bg-success">ACTIVA</span>
    {% else %}<span class="badge text-bg-secondary">CERRADA</span>{% endif %}
  </p>

  {# ===== M√≥vil: CARDS ===== #}
  <div class="only-mobile cards-grid" id="cards-servicios">
    {% for s in servicios %}
    <article class="card-svc card-svc--compact card-link" data-id="{{ s.id }}" data-href="{% url 'servicios:detail' s.id %}">
      <div class="body">
        {% if es_gerente and ruta.estado == 'ACTIVA' %}
          <button type="button" class="drag-handle" aria-label="Reordenar">
            <span class="dots"><div></div><div></div><div></div><div></div><div></div><div></div></span>
          </button>
        {% else %}
          <div style="width:28px;"></div>
        {% endif %}

        <div class="order-badge">{{ s.orden }}</div>

        <h6 class="title">{{ s.cliente }}</h6>
        <div>
          {% if s.entregado %}
            <span class="status-pill status-entregado">Entregado</span>
          {% elif s.recogido %}
            <span class="status-pill status-enruta">En ruta</span>
          {% else %}
            <span class="status-pill status-pendiente">Pendiente</span>
          {% endif %}
        </div>

        <div class="sub">{{ s.origen|default:"‚Äî" }} ‚Üí {{ s.destino|default:"‚Äî" }}</div>

        {% if ruta.estado == 'ACTIVA' %}
          {% if es_gerente or es_conductor %}
            <div class="inline-actions">
              {% if not s.recogido %}
                <form id="mrec-{{ s.id }}" method="post" action="{% url 'servicios:marcar_recogido' s.id %}">
                  {% csrf_token %}
                  <input type="hidden" name="lat" id="mrec-lat-{{ s.id }}">
                  <input type="hidden" name="lon" id="mrec-lon-{{ s.id }}">
                  <button type="button"
                          class="btn-chip btn-chip-info"
                          onclick="event.stopPropagation(); enviarConUbicacion('mrec-{{ s.id }}','mrec-lat-{{ s.id }}','mrec-lon-{{ s.id }}')">
                    üì¶Marcar como - Recogido
                  </button>
                </form>
              {% endif %}
              {% if s.recogido and not s.entregado %}
                <form id="ment-{{ s.id }}" method="post" action="{% url 'servicios:marcar_entregado' s.id %}">
                  {% csrf_token %}
                  <input type="hidden" name="lat" id="ment-lat-{{ s.id }}">
                  <input type="hidden" name="lon" id="ment-lon-{{ s.id }}">
                  <button type="button"
                          class="btn-chip btn-chip-success"
                          onclick="event.stopPropagation(); enviarConUbicacion('ment-{{ s.id }}','ment-lat-{{ s.id }}','ment-lon-{{ s.id }}')">
                    ‚úÖ Marcar como - Entregado
                  </button>
                </form>
              {% endif %}
            </div>
          {% endif %}
        {% endif %}
      </div>
    </article>
    {% empty %}
      <div class="text-muted">Sin servicios en esta ruta.</div>
    {% endfor %}
  </div>

  {# ===== Desktop/Tablet: TABLA (sin cambios) ===== #}
  <div class="card only-desktop">
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            {% if es_gerente and ruta.estado == 'ACTIVA' %}
              <th class="text-center" style="width:46px;"></th>
            {% endif %}
            <th>Orden</th>
            <th>#</th>
            <th>Cliente</th>
            <th>Origen ‚Üí Destino</th>
            <th class="text-end">Valor</th>
            <th>Pago</th>
            <th>Estado</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla-servicios">
          {% for s in servicios %}
          <tr data-id="{{ s.id }}">
            {% if es_gerente and ruta.estado == 'ACTIVA' %}
              <td class="text-center">
                <button type="button" class="drag-handle" aria-label="Reordenar">
                  <span class="dots"><div></div><div></div><div></div><div></div><div></div><div></div></span>
                </button>
              </td>
            {% endif %}
            <td>{{ s.orden }}</td>
            <td>{{ s.id }}</td>
            <td>{{ s.cliente }}</td>
            <td><small>{{ s.origen|default:"‚Äî" }} ‚Üí {{ s.destino|default:"‚Äî" }}</small></td>
            <td class="text-end">{{ s.valor|money }}</td>
            <td>
              {% if s.estado_pago == 'PAG' %}
                <span class="badge text-bg-success">Pagado</span>
              {% elif s.estado_pago == 'ANT' %}
                <span class="badge text-bg-warning">Anticipo {{ s.anticipo|money }}</span>
              {% else %}
                <span class="badge text-bg-secondary">Pendiente</span>
              {% endif %}
            </td>
            <td>
              {% if s.entregado %}‚úÖ Entregado
              {% elif s.recogido %}üì¶ En ruta
              {% else %}‚è≥ Pendiente{% endif %}
            </td>
            <td class="actions">
              <div class="row-actions">
                <a class="btn btn-outline-primary btn-compact" href="{% url 'servicios:detail' s.id %}">Detalle</a>
                {% if ruta.estado == 'ACTIVA' %}
                  {% if es_gerente or es_conductor %}
                    {% if not s.recogido %}
                      <form id="rec-{{ s.id }}" method="post" action="{% url 'servicios:marcar_recogido' s.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="lat" id="rec-lat-{{ s.id }}">
                        <input type="hidden" name="lon" id="rec-lon-{{ s.id }}">
                        <button type="button" class="btn btn-outline-info btn-compact"
                                onclick="enviarConUbicacion('rec-{{ s.id }}','rec-lat-{{ s.id }}','rec-lon-{{ s.id }}')">
                          Marcar recogido
                        </button>
                      </form>
                    {% endif %}
                    {% if s.recogido and not s.entregado %}
                      <form id="ent-{{ s.id }}" method="post" action="{% url 'servicios:marcar_entregado' s.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="lat" id="ent-lat-{{ s.id }}">
                        <input type="hidden" name="lon" id="ent-lon-{{ s.id }}">
                        <button type="button" class="btn btn-outline-success btn-compact"
                                onclick="enviarConUbicacion('ent-{{ s.id }}','ent-lat-{{ s.id }}','ent-lon-{{ s.id }}')">
                          Marcar entregado
                        </button>
                      </form>
                    {% endif %}
                  {% endif %}
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
            <tr><td colspan="{% if es_gerente and ruta.estado == 'ACTIVA' %}9{% else %}8{% endif %}" class="text-center text-muted py-4">Sin servicios en esta ruta.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function enviarConUbicacion(formId, latId, lonId){
  const form = document.getElementById(formId);
  if (!form) return;
  if (!navigator.geolocation){ form.submit(); return; }
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      const lat = document.getElementById(latId);
      const lon = document.getElementById(lonId);
      if(lat) lat.value = pos.coords.latitude;
      if(lon) lon.value = pos.coords.longitude;
      form.submit();
    },
    ()=>{ form.submit(); },
    { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
  );
}

/* Tap en card -> ir al detalle, pero ignorar clicks en drag, forms o inline-actions */
document.addEventListener('click', function(e){
  const card = e.target.closest('#cards-servicios .card-link');
  if (!card) return;
  if (e.target.closest('.inline-actions') || e.target.closest('form') || e.target.closest('.drag-handle')) return;
  const href = card.getAttribute('data-href');
  if (href) window.location = href;
});
</script>

{% if es_gerente and ruta.estado == 'ACTIVA' %}
  <!-- CDN de SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script>
  (function(){
    // CSRF para fetch
    function getCookie(name){
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i=0;i<cookies.length;i++){
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length+1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length+1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    async function sendOrder(order){
      const resp = await fetch("{% url 'rutas:reordenar_servicios' ruta.id %}", {
        method: "POST",
        headers: {"Content-Type":"application/json","X-CSRFToken": csrftoken},
        body: JSON.stringify(order),
        credentials: "same-origin"
      });
      if (resp.ok){
        const n = document.createElement('div');
        n.textContent = "Orden guardado";
        n.style.cssText = "position:fixed;bottom:14px;left:14px;background:#0d6efd;color:#fff;padding:8px 12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.15);z-index:9999;";
        document.body.appendChild(n);
        setTimeout(()=>n.remove(), 1200);
      } else {
        console.error("Guardar orden:", resp.status, await resp.text());
        alert("No se pudo guardar el nuevo orden.");
      }
    }

    function ids(container, selector){
      return Array.from(container.querySelectorAll(selector)).map(el => parseInt(el.dataset.id));
    }

    // ----- Desktop (tabla) -----
    const tbody = document.getElementById('tabla-servicios');
    if (tbody){
      Sortable.create(tbody, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        delayOnTouchOnly: true,
        delay: 150,
        onEnd(){ sendOrder(ids(tbody, 'tr[data-id]')); }
      });
    }

    // ----- M√≥vil (cards) -----
    const cards = document.getElementById('cards-servicios');
    if (cards){
      Sortable.create(cards, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        delayOnTouchOnly: true,
        delay: 150,
        onEnd(){ sendOrder(ids(cards, '.card-svc[data-id]')); }
      });
    }
  })();
  </script>
{% endif %}
{% endblock %}
