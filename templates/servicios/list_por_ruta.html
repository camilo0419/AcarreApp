{% extends "base.html" %}
{% load l10n formatting %}
{% block title %}Servicios de la ruta #{{ ruta.id }}{% endblock %}

{% block extra_css %}
<style>
/* ===== Scope: solo dentro de #svc-list ===== */
#svc-list .only-desktop{display:block !important;}
#svc-list .only-mobile{display:none !important;}
@media (max-width: 767.98px){
  #svc-list .only-desktop{display:none !important;}
  #svc-list .only-mobile{display:block !important;}
}

/* tabla (desktop) */
table.table td.actions{text-align:right;white-space:nowrap;vertical-align:middle;}
table.table td.actions .row-actions{display:flex !important;gap:8px !important;flex-wrap:wrap !important;justify-content:flex-end !important;align-items:center !important;}
table.table td.actions form{display:inline-block !important;margin:0 !important;}
.btn-compact{display:inline-flex !important;align-items:center !important;justify-content:center !important;padding:6px 12px !important;font-size:.92rem !important;line-height:1.15 !important;border-radius:12px !important;}
@media (max-width: 900px){
  table.table td.actions{text-align:left;}
  table.table td.actions .row-actions{justify-content:flex-start !important;}
}

/* cards (móvil) */
.cards-grid{display:grid;gap:12px;}
.card-svc{border:1px solid #eceef3;background:#fff;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.05);}
.card-svc .body{padding:14px 16px;}
.card-svc .footer{padding:12px 16px;display:flex;gap:8px;justify-content:flex-end;}
.svc-head{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;}
.svc-title{margin:0;font-size:16px;}
.svc-sub{margin-top:2px;color:#6b7280;font-size:12.5px;}
.svc-meta{display:grid;gap:6px;margin:10px 0 0;}
.svc-meta dt{font-weight:700;color:#2b2f3a;}
.svc-meta dd{margin:0;color:#333;}
.svc-links{margin-top:6px;font-size:12.5px;}
.svc-links a{color:#6b7280;text-decoration:none;}
.svc-links a:hover{text-decoration:underline;}

@media (max-width: 767.98px){
  .cards-grid{grid-template-columns:1fr;}
  @supports (aspect-ratio:1){
    .card-svc{aspect-ratio:1.05/1;display:flex;flex-direction:column;}
    .card-svc .body{flex:1 1 auto;overflow:auto;}
  }
}
</style>
{% endblock %}

{% block content %}
<div id="svc-list">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="m-0">Servicios — Ruta #{{ ruta.id }} {{ ruta.nombre|default:"" }}</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'rutas:list' %}">⬅️ Rutas</a>
      <a class="btn btn-outline-dark" href="{% url 'rutas:hoja' ruta.id %}">🧾 Hoja de ruta</a>
      {% if es_gerente and ruta.estado == 'ACTIVA' %}
        <a class="btn btn-primary" href="{% url 'servicios:crear' %}?ruta={{ ruta.id }}">➕ Agregar servicio</a>
      {% endif %}
    </div>
  </div>

  <p class="text-muted">
    <strong>Fecha:</strong> {{ ruta.fecha_salida|date:"Y-m-d" }} —
    <strong>Vehículo:</strong> {{ ruta.vehiculo|default:"—" }} —
    <strong>Conductor:</strong> {{ ruta.conductor.username|default:"—" }} —
    <strong>Estado:</strong>
    {% if ruta.estado == 'ACTIVA' %}<span class="badge text-bg-success">ACTIVA</span>
    {% else %}<span class="badge text-bg-secondary">CERRADA</span>{% endif %}
  </p>

  {# ===== Desktop/Tablet: TABLA ===== #}
  <div class="card only-desktop">
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Cliente</th>
            <th>Origen → Destino</th>
            <th class="text-end">Valor</th>
            <th>Pago</th>
            <th>Estado</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for s in servicios %}
          <tr>
            <td>{{ s.id }}</td>
            <td>{{ s.cliente }}</td>
            <td>
              <small>{{ s.origen|default:"—" }} → {{ s.destino|default:"—" }}</small>
              <div class="small">
                {% if s.lat_recogida and s.lon_recogida %}
                  <a class="link-secondary" target="_blank"
                     href="https://www.google.com/maps/dir/?api=1&destination={{ s.lat_recogida|unlocalize }},{{ s.lon_recogida|unlocalize }}">📍 Ir a recogida</a>
                  · <a class="link-secondary" target="_blank"
                       href="https://www.google.com/maps/search/?api=1&query={{ s.lat_recogida|unlocalize }},{{ s.lon_recogida|unlocalize }}">🔎 Ver</a>
                {% endif %}
                {% if s.lat_entrega and s.lon_entrega %}
                  · <a class="link-secondary" target="_blank"
                       href="https://www.google.com/maps/dir/?api=1&destination={{ s.lat_entrega|unlocalize }},{{ s.lon_entrega|unlocalize }}">📦 Ir a entrega</a>
                  · <a class="link-secondary" target="_blank"
                       href="https://www.google.com/maps/search/?api=1&query={{ s.lat_entrega|unlocalize }},{{ s.lon_entrega|unlocalize }}">🔎 Ver</a>
                {% endif %}
              </div>
            </td>
            <td class="text-end">{{ s.valor|money }}</td>
            <td>
              {% if s.estado_pago == 'PAG' %}
                <span class="badge text-bg-success">Pagado</span>
              {% elif s.estado_pago == 'ANT' %}
                <span class="badge text-bg-warning">Anticipo {{ s.anticipo|money }}</span>
              {% else %}
                <span class="badge text-bg-secondary">Pendiente</span>
              {% endif %}
            </td>
            <td>
              {% if s.entregado %}✅ Entregado
              {% elif s.recogido %}📦 En ruta
              {% else %}⏳ Pendiente
              {% endif %}
              <div class="small text-muted">
                {% if s.recogido_en %}Recogido: {{ s.recogido_en|date:"Y-m-d H:i" }}{% endif %}
                {% if s.entregado_en %} · Entregado: {{ s.entregado_en|date:"Y-m-d H:i" }}{% endif %}
              </div>
            </td>

            <td class="actions">
              <div class="row-actions">
                <a class="btn btn-outline-primary btn-compact" href="{% url 'servicios:detail' s.id %}">Detalle</a>

                {# FIX: sin paréntesis; if anidados #}
                {% if ruta.estado == 'ACTIVA' %}
                  {% if es_gerente or es_conductor %}
                    {% if not s.recogido %}
                      <form id="rec-{{ s.id }}" method="post" action="{% url 'servicios:marcar_recogido' s.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="lat" id="rec-lat-{{ s.id }}">
                        <input type="hidden" name="lon" id="rec-lon-{{ s.id }}">
                        <button type="button" class="btn btn-outline-info btn-compact"
                                onclick="enviarConUbicacion('rec-{{ s.id }}','rec-lat-{{ s.id }}','rec-lon-{{ s.id }}')">
                          Marcar recogido
                        </button>
                      </form>
                    {% endif %}
                    {% if s.recogido and not s.entregado %}
                      <form id="ent-{{ s.id }}" method="post" action="{% url 'servicios:marcar_entregado' s.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="lat" id="ent-lat-{{ s.id }}">
                        <input type="hidden" name="lon" id="ent-lon-{{ s.id }}">
                        <button type="button" class="btn btn-outline-success btn-compact"
                                onclick="enviarConUbicacion('ent-{{ s.id }}','ent-lat-{{ s.id }}','ent-lon-{{ s.id }}')">
                          Marcar entregado
                        </button>
                      </form>
                    {% endif %}
                  {% endif %}
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
            <tr><td colspan="7" class="text-center text-muted py-4">Sin servicios en esta ruta.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {# ===== Móvil: CARDS ===== #}
  <div class="only-mobile cards-grid">
    {% for s in servicios %}
    <article class="card-svc">
      <div class="body">
        <div class="svc-head">
          <h5 class="svc-title">Servicio #{{ s.id }}</h5>
          <span class="badge
            {% if s.estado_pago == 'PAG' %}text-bg-success
            {% elif s.estado_pago == 'ANT' %}text-bg-warning
            {% else %}text-bg-secondary{% endif %}">
            {% if s.estado_pago == 'PAG' %}Pagado{% elif s.estado_pago == 'ANT' %}Anticipo{% else %}Pendiente{% endif %}
          </span>
        </div>
        <div class="svc-sub">Ruta #{{ ruta.id }} — {{ s.origen|default:"—" }} → {{ s.destino|default:"—" }}</div>
        <dl class="svc-meta">
          <div><dt>Cliente</dt><dd>{{ s.cliente }}</dd></div>
          <div><dt>Valor</dt><dd>{{ s.valor|money }}</dd></div>
          <div><dt>Estado</dt><dd>
            {% if s.entregado %}✅ Entregado
            {% elif s.recogido %}📦 En ruta
            {% else %}⏳ Pendiente{% endif %}
          </dd></div>
        </dl>
        <div class="svc-links">
          {% if s.lat_recogida and s.lon_recogida %}
            <a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination={{ s.lat_recogida|unlocalize }},{{ s.lon_recogida|unlocalize }}">📍 Ir a recogida</a>
            · <a target="_blank" href="https://www.google.com/maps/search/?api=1&query={{ s.lat_recogida|unlocalize }},{{ s.lon_recogida|unlocalize }}">🔎 Ver</a>
          {% endif %}
          {% if s.lat_entrega and s.lon_entrega %}
            · <a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination={{ s.lat_entrega|unlocalize }},{{ s.lon_entrega|unlocalize }}">📦 Ir a entrega</a>
            · <a target="_blank" href="https://www.google.com/maps/search/?api=1&query={{ s.lat_entrega|unlocalize }},{{ s.lon_entrega|unlocalize }}">🔎 Ver</a>
          {% endif %}
        </div>
      </div>
      <div class="footer">
        <a class="btn btn-sm btn-outline-primary" href="{% url 'servicios:detail' s.id %}">Detalle</a>

        {# FIX: sin paréntesis; if anidados #}
        {% if ruta.estado == 'ACTIVA' %}
          {% if es_gerente or es_conductor %}
            {% if not s.recogido %}
              <form id="mrec-{{ s.id }}" method="post" action="{% url 'servicios:marcar_recogido' s.id %}">
                {% csrf_token %}
                <input type="hidden" name="lat" id="mrec-lat-{{ s.id }}">
                <input type="hidden" name="lon" id="mrec-lon-{{ s.id }}">
                <button type="button" class="btn btn-sm btn-outline-info"
                        onclick="enviarConUbicacion('mrec-{{ s.id }}','mrec-lat-{{ s.id }}','mrec-lon-{{ s.id }}')">
                  Recogido
                </button>
              </form>
            {% endif %}
            {% if s.recogido and not s.entregado %}
              <form id="ment-{{ s.id }}" method="post" action="{% url 'servicios:marcar_entregado' s.id %}">
                {% csrf_token %}
                <input type="hidden" name="lat" id="ment-lat-{{ s.id }}">
                <input type="hidden" name="lon" id="ment-lon-{{ s.id }}">
                <button type="button" class="btn btn-sm btn-outline-success"
                        onclick="enviarConUbicacion('ment-{{ s.id }}','ment-lat-{{ s.id }}','ment-lon-{{ s.id }}')">
                  Entregado
                </button>
              </form>
            {% endif %}
          {% endif %}
        {% endif %}
      </div>
    </article>
    {% empty %}
      <div class="text-muted">Sin servicios en esta ruta.</div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function enviarConUbicacion(formId, latId, lonId){
  const form = document.getElementById(formId);
  if (!form) return;
  if (!navigator.geolocation){ form.submit(); return; }
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      const lat = document.getElementById(latId);
      const lon = document.getElementById(lonId);
      if(lat) lat.value = pos.coords.latitude;
      if(lon) lon.value = pos.coords.longitude;
      form.submit();
    },
    ()=>{ form.submit(); },
    { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
  );
}
</script>
{% endblock %}
