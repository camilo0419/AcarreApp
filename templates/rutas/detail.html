{% extends "base.html" %}
{% load formatting %}
{% load humanize %}
{% block title %}Hoja de ruta â€” {{ ruta.nombre|default:"(sin nombre)" }} #{{ ruta.id }}{% endblock %}

{% block extra_css %}
<style>
  /* Botonera alineada */
  .actions-inline{
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
  }
  .actions-inline form{ display:inline-block; margin:0; }

  /* ===== KPIs con aire ===== */
  .kpis{
    display:grid;
    grid-template-columns: repeat(3,1fr);
    gap:20px;             /* separaciÃ³n entre tarjetas */
    margin-bottom:20px;   /* aire abajo del grupo */
  }
  .kpis > *{ min-width:0; }
  @media (max-width: 992px){
    .kpis{ grid-template-columns:1fr; gap:16px; margin-bottom:16px; }
  }
  .kpi{
    border:1px solid var(--line-200);
    border-radius:12px;
    padding:14px 16px;
    background:var(--surface);
    box-shadow:var(--shadow-1);
  }
  .kpi .label{ font-size:.95rem; color:var(--text-600); font-weight:600; }
  .kpi .value{ font-size:1.6rem; line-height:1.2; font-weight:800; margin-top:2px; }
  .kpi .desc { font-size:.85rem; color:var(--text-500); margin-top:2px; }

  /* Tablas */
  .mov-block h6{ font-size:1.05rem; font-weight:800; color:var(--text-700); }
  .mov-table thead th{ font-size:.95rem; }
  .mov-table tfoot th, .mov-table tfoot td{
    border-top:2px solid var(--line-300);
    font-weight:800;
    background:var(--bg-soft);
  }

  /* ===== Formularios de Caja (horizontales) ===== */
  .caja-grid{ display:grid; gap:12px; }
  @media (min-width:768px){
    /* Concepto (1fr) â€” Valor (170px) â€” BotÃ³n (auto) */
    .caja-grid{ grid-template-columns:1fr 170px auto; align-items:end; }
  }
  .caja-grid .input{ width:100%; }
  .caja-card{
    border:1px solid var(--line-200);
    border-radius:12px;
    box-shadow:var(--shadow-1);
    background:#fff;
    padding:12px;
  }
  .caja-card .card-title{
    font-weight:700;
    margin:4px 4px 12px;
    display:flex; align-items:center; gap:8px;
  }
  /* Diferenciar ingreso/gasto visualmente */
  .caja-ingreso{ border-left:6px solid #2F7D32; }
  .caja-gasto  { border-left:6px solid #B00020; }
  .caja-ingreso .card-title{ color:#236a3b; }
  .caja-gasto  .card-title{ color:#8a1a1a; }

  .caja-grid > *{ margin:0; } /* inputs limpios */
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="m-0">
    Hoja de ruta â€” {{ ruta.nombre|default:"(sin nombre)" }} <small class="text-muted">#{{ ruta.id }}</small>
  </h1>

  <div class="actions-inline">
    <a class="btn btn-outline-primary" href="{% url 'servicios:por_ruta' ruta.id %}">ðŸ“‹ Ver servicios (lista)</a>

    {% if user.is_superuser or user.is_staff %}
      {% if ruta.estado == "ACTIVA" %}
        <form method="post"
              action="{% url 'rutas:cerrar' ruta.id %}"
              onsubmit="return confirm('Â¿Seguro que quieres cerrar la ruta #{{ ruta.id }}? Ya no se podrÃ¡n operar servicios y se generarÃ¡ el cierre.');">
          {% csrf_token %}
          <button class="btn btn-outline-danger">ðŸ”’ Cerrar ruta</button>
        </form>
      {% else %}
        <a class="btn btn-outline-dark" href="{% url 'rutas:cierre_resumen' ruta.id %}">ðŸ“„ Ver resumen del cierre</a>
      {% endif %}
    {% endif %}
  </div>
</div>

<!-- Badges -->
<div class="mb-3">
  {% if ruta.estado == "ACTIVA" %}
    <span class="badge text-bg-success">Ruta ACTIVA</span>
  {% else %}
    <span class="badge text-bg-secondary">Ruta CERRADA</span>
  {% endif %}
  {% if ruta.vehiculo %}
    <span class="badge text-bg-light text-dark">
      VehÃ­culo: {% firstof ruta.vehiculo.placa ruta.vehiculo|stringformat:"s" "â€”" %}
    </span>
  {% endif %}
  {% if ruta.conductor %}
    <span class="badge text-bg-light text-dark">
      Conductor: {% firstof ruta.conductor.get_full_name ruta.conductor.username "â€”" %}
    </span>
  {% endif %}
  {% if ruta.fecha_salida %}
    <span class="badge text-bg-light text-dark">Salida: {{ ruta.fecha_salida|date:"Y-m-d" }}</span>
  {% endif %}
</div>

<div class="row g-3">
  <!-- Servicios -->
  <div class="col-lg-7">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Servicios en la ruta</span>
        <small class="text-muted">Total: {{ servicios|length }}</small>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="text-center" style="width:80px;">ID</th>
                <th style="min-width:160px;">Cliente</th>
                <th>Origen â†’ Destino</th>
                <th class="text-end" style="width:140px;">Valor</th>
                <th class="text-center" style="width:120px;">Pago</th>
                <th class="text-center" style="width:120px;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for s in servicios %}
              <tr>
                <td class="text-center">#{{ s.id }}</td>
                <td>{% firstof s.cliente.nombre s.cliente "â€”" %}</td>
                <td>{{ s.origen|default:"â€”" }} â†’ {{ s.destino|default:"â€”" }}</td>
                <td class="text-end">{{ s.valor|default:0|money }}</td>
                <td class="text-center">
                  {% if s.estado_pago == "PEND" %}
                    <span class="badge text-bg-secondary">Pendiente</span>
                  {% elif s.estado_pago == "ANT" %}
                    <span class="badge text-bg-warning">Anticipo</span>
                  {% else %}
                    <span class="badge text-bg-success">Pagado</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'servicios:detail' s.id %}">Detalle</a>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="6" class="text-center text-muted py-4">Sin servicios.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Caja -->
  <div class="col-lg-5">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Caja de ruta</span>
        <small class="text-muted">Base efectivo: <strong>{{ ruta.base_efectivo|default:0|money }}</strong></small>
      </div>
      <div class="card-body">
        <!-- KPIs -->
        <div class="kpis mb-3">
          <div class="kpi">
            <div class="label">Ingresos</div>
            <div class="value">{{ total_ingresos|default_if_none:0|money }}</div>
            <div class="desc">Incluye base inicial</div>
          </div>
          <div class="kpi">
            <div class="label">Gastos</div>
            <div class="value">{{ total_gastos|default_if_none:0|money }}</div>
            <div class="desc">Salidas de efectivo</div>
          </div>
          <div class="kpi">
            <div class="label">Caja actual</div>
            <div class="value">{{ disponible|default_if_none:0|money }}</div>
            <div class="desc">Efectivo disponible</div>
          </div>
        </div>

        {% if ruta.estado == "ACTIVA" %}
          {% if es_gerente or es_conductor %}
            <div class="row g-3">
              <!-- INGRESO -->
              <div class="col-md-12">
                <div class="caja-card caja-ingreso">
                  <div class="card-title">Registrar ingreso</div>
                  <form method="post" action="{% url 'rutas:ingreso' ruta.id %}" class="caja-grid">
                    {% csrf_token %}
                    <div>
                      <label class="form-label small text-muted">Concepto</label>
                      <input class="input" name="concepto" type="text" placeholder="Ej: Otros ingresos" required>
                    </div>
                    <div>
                      <label class="form-label small text-muted">Valor</label>
                      <input class="input" name="valor" type="number" min="1" step="1" placeholder="0" required>
                    </div>
                    <div>
                      <label class="form-label sr-only">Guardar</label>
                      <button class="btn btn-outline-success w-100">Guardar ingreso</button>
                    </div>
                  </form>
                </div>
              </div>

              <!-- GASTO -->
              <div class="col-md-12">
                <div class="caja-card caja-gasto">
                  <div class="card-title">Registrar gasto</div>
                  <form method="post" action="{% url 'rutas:gasto' ruta.id %}" class="caja-grid">
                    {% csrf_token %}
                    <div>
                      <label class="form-label small text-muted">Concepto</label>
                      <input class="input" name="concepto" type="text" placeholder="Ej: Combustible / Peaje / Parqueadero" required>
                    </div>
                    <div>
                      <label class="form-label small text-muted">Valor</label>
                      <input class="input" name="valor" type="number" min="1" step="1" placeholder="0" required>
                    </div>
                    <div>
                      <label class="form-label sr-only">Guardar</label>
                      <button class="btn btn-outline-danger w-100">Guardar gasto</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          {% endif %}
        {% endif %}

        <!-- Listados de movimientos -->
        <hr>
        <div class="row g-3 mov-block">
          <div class="col-md-6">
            <h6 class="text-muted">Ingresos</h6>
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mov-table">
                <thead>
                  <tr>
                    <th>Concepto</th>
                    <th class="text-end" style="width:140px;">Valor</th>
                    <th class="text-muted small" style="width:160px;">Fecha</th>
                  </tr>
                </thead>
                <tbody>
                  {% for m in movimientos %}
                    {% if m.tipo == "INGRESO" %}
                      <tr>
                        <td>{% firstof m.concepto m.servicio.nombre m.servicio|stringformat:"s" "(sin detalle)" %}</td>
                        <td class="text-end">{{ m.valor|money }}</td>
                        <td class="text-muted small">{{ m.timestamp|date:"Y-m-d H:i" }}</td>
                      </tr>
                    {% endif %}
                  {% empty %}
                    <tr><td colspan="3" class="text-center text-muted">Sin movimientos.</td></tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr>
                    <th class="text-end">Total ingresos (sin base)</th>
                    <td class="text-end">{{ ingresos_sin_base|default_if_none:0|money }}</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="col-md-6">
            <h6 class="text-muted">Gastos</h6>
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mov-table">
                <thead>
                  <tr>
                    <th>Concepto</th>
                    <th class="text-end" style="width:140px;">Valor</th>
                    <th class="text-muted small" style="width:160px;">Fecha</th>
                  </tr>
                </thead>
                <tbody>
                  {% for m in movimientos %}
                    {% if m.tipo == "GASTO" %}
                      <tr>
                        <td>{{ m.concepto|default:"(sin detalle)" }}</td>
                        <td class="text-end">{{ m.valor|money }}</td>
                        <td class="text-muted small">{{ m.timestamp|date:"Y-m-d H:i" }}</td>
                      </tr>
                    {% endif %}
                  {% empty %}
                    <tr><td colspan="3" class="text-center text-muted">Sin movimientos.</td></tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr>
                    <th class="text-end">Total gastos</th>
                    <td class="text-end">{{ total_gastos|default_if_none:0|money }}</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

      </div><!-- card-body -->
    </div>
  </div>
</div>
{% endblock %}
