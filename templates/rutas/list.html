{% extends "base.html" %}
{% load formatting l10n %}
{% block title %}Rutas{% endblock %}

{% block extra_css %}
<style>
/* ===== Scope: solo dentro de #rutas-page ===== */
#rutas-page .only-desktop{display:block !important;}
#rutas-page .only-mobile{display:none !important;}
@media (max-width: 767.98px){
  #rutas-page .only-desktop{display:none !important;}
  #rutas-page .only-mobile{display:block !important;}
}

/* Encabezado */
.page-header{display:flex;align-items:center;gap:12px}
.page-actions{margin:6px 0 14px}

#rutas-page .btn-cierre{background:#f59e0b;border-color:#f59e0b;color:#111827;}
#rutas-page .btn-cierre:hover{background:#d97706;border-color:#d97706;color:#ffffff;}

/* ===== Cards m√≥vil ===== */
.cards-grid{display:grid;gap:12px;}
.card-ruta{border:1px solid #eceef3;background:#fff;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.05);}
.card-ruta .body{
  padding:14px 16px;
  display:grid;
  grid-template-columns: 1fr 220px;   /* izq info / der panel */
  grid-template-rows: auto 1fr;
  column-gap:14px; row-gap:10px;
}
.card-ruta .footer{padding:12px 16px;display:flex;gap:10px;justify-content:center;}

.ruta-head{grid-column:1 / span 2;display:flex;justify-content:space-between;align-items:flex-start;gap:8px;}
.ruta-title{margin:0;font-size:16px;}

/* P√≠ldoras de estado */
.pill{display:inline-block;padding:6px 12px;border-radius:9999px;font-size:12px;font-weight:700}
.pill--ok{background:#e8f8ee;color:#166534;border:1px solid #86efac;}
.pill--bad{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;}

/* Izquierda: meta simple */
.ruta-meta{display:grid;gap:6px;margin:0;}
.ruta-meta dt{font-weight:700;color:#2b2f3a;}
.ruta-meta dd{margin:0;color:#333;}

/* Derecha: panel de m√©tricas */
.side-info{
  border:1px solid #eceef3;background:#f8fafc;border-radius:12px;padding:10px;
  display:flex;flex-direction:column;gap:8px;align-self:stretch;
}
.metric{
  display:flex;justify-content:space-between;align-items:center;
  background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;
}
.metric small{color:#6b7280;}
.metric b{font-weight:800;}
.metric .ok{color:#166534;}
.metric .bad{color:#991b1b;}

/* Botones al pie */
.card-ruta .footer .btn{min-width:110px}

/* Fallback de grid en navegadores viejos */
@media (max-width: 767.98px){
  @supports not (grid-template-columns: 1fr 220px){
    .card-ruta .body{display:block;}
    .side-info{margin-top:10px;}
  }
}
</style>
{% endblock %}

{% block content %}
<div id="rutas-page">
  <header class="page-header">
    <h1 class="m-0">Rutas</h1>
  </header>

  <div class="page-actions">
    {% if user.is_superuser or user.is_staff %}
      <a class="btn btn-primary" href="{% url 'rutas:crear' %}">‚ûï Crear ruta</a>
    {% endif %}
  </div>

  {# ===== Desktop/Tablet: TABLA ===== #}
  <div class="only-desktop card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th class="text-center">ID</th>
              <th>Nombre</th>
              <th>Fecha salida</th>
              <th>Veh√≠culo</th>
              <th>Conductor</th>
              <th>Estado</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rutas %}
              <tr>
                <td class="text-center">
                  <a href="{% url 'servicios:por_ruta' r.pk %}">#{{ r.id }}</a>
                </td>
                <td>{{ r.nombre|default:"(sin nombre)" }}</td>
                <td>{{ r.fecha_salida|date:"Y-m-d" }}</td>
                <td>{{ r.vehiculo|default:"‚Äî" }}</td>
                <td>{{ r.conductor.username|default:"‚Äî" }}</td>
                <td>
                  {% if r.estado == "ACTIVA" %}
                    <span class="pill pill--ok">ACTIVA</span>
                  {% else %}
                    <span class="pill pill--bad">CERRADA</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  <a href="{% url 'servicios:por_ruta' r.pk %}" class="btn btn-sm btn-outline-primary">Ver</a>
                  <a href="{% url 'rutas:hoja' r.pk %}" class="btn btn-sm btn-outline-secondary">Hoja de ruta</a>
                  {% if r.estado == "CERRADA" %}
                    <a href="{% url 'rutas:cierre_resumen' r.pk %}" class="btn btn-sm btn-cierre">üìä Ver cierre</a>
                  {% endif %}
                  {% if user.is_superuser or user.is_staff %}
                    {% if r.estado == "ACTIVA" %}
                      <a href="{% url 'rutas:borrar' r.pk %}" class="btn btn-sm btn-outline-dark"
                         onclick="return confirm('¬øBorrar ruta y sus servicios/movimientos?');">üóëÔ∏è Borrar</a>
                    {% endif %}
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  {% with rol=user.userprofile.rol|default_if_none:'' %}
                    {% if rol == 'CONDUCTOR' %}No tienes rutas asignadas actualmente.{% else %}No hay rutas registradas.{% endif %}
                  {% endwith %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# ===== M√≥vil: CARDS ===== #}
  <div class="only-mobile cards-grid">
    {% for r in rutas %}
    <article class="card-ruta">
      <div class="body">
        <!-- Encabezado -->
        <div class="ruta-head">
          <h5 class="ruta-title">Ruta #{{ r.id }} ‚Äî {{ r.nombre|default:"(sin nombre)" }}</h5>
          {% if r.estado == 'CERRADA' %}
            <span class="pill pill--bad">CERRADA</span>
          {% else %}
            <span class="pill pill--ok">ACTIVA</span>
          {% endif %}
        </div>

        <!-- Columna izquierda (meta) -->
        <dl class="ruta-meta">
          <div><dt>Fecha</dt><dd>{{ r.fecha_salida|date:"Y-m-d" }}</dd></div>
          <div><dt>Veh√≠culo</dt><dd>{{ r.vehiculo|default:"‚Äî" }}</dd></div>
          <div><dt>Conductor</dt><dd>{{ r.conductor.username|default:"‚Äî" }}</dd></div>
        </dl>

        <!-- Columna derecha (sin duplicados) -->
        <div class="side-info">
          <div class="metric">
            <small>Servicios</small>
            <b>{{ r.servicios.count }}</b>
          </div>
          <div class="metric">
            <small>Estado</small>
            {% if r.estado == 'CERRADA' %}
              <b class="bad">Cerrada</b>
            {% else %}
              <b class="ok">Activa</b>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Pie -->
      <div class="footer">
        <a href="{% url 'servicios:por_ruta' r.pk %}" class="btn btn-sm btn-outline-primary">Ver</a>
        <a href="{% url 'rutas:hoja' r.pk %}" class="btn btn-sm btn-outline-secondary">Hoja de ruta</a>
        {% if r.estado == "CERRADA" %}
          <a href="{% url 'rutas:cierre_resumen' r.pk %}" class="btn btn-sm btn-cierre">Cierre</a>
        {% endif %}
      </div>
    </article>
    {% empty %}
      <div class="text-muted">No hay rutas registradas.</div>
    {% endfor %}
  </div>
</div>
{% endblock %}
